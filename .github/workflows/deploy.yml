name: Deploy to Lightsail

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # Load environment (for npm/pm2)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            source ~/.profile || true
            source ~/.bashrc || true
            
            # Ensure proper Node version (v20)
            nvm install 20
            nvm use 20

            # Debug info
            echo "Deploying as: $(whoami)"
            echo "In directory: $(pwd)"

            # Fix permissions
            sudo chown -R $USER:$USER tripplanner || true

            # Navigate
            cd tripplanner
            
            # Force sync with remote (discard local changes/conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            npm install
            
            # Create a version file to verify build
            echo "Build Date: $(date)" > public/version.txt
            
            # Clean build artifact to force fresh build
            rm -rf .next
            npm run build
            
            # Force restart from THIS directory
            pm2 delete lfg-places || true
            # Explicitly start on port 3000
            pm2 start npm --name "lfg-places" -- start -- -p 3000
            pm2 save
            
            # Verify local operation
            echo "Verifying local server..."
            sleep 5
            echo "--- LOCAL VERSION ---"
            curl http://localhost:3000/version.txt || echo "WARNING: Local verify failed"
            echo "---------------------"
            
            # Diagnostic: Check web server config
            echo "--- WEB SERVER DIAGNOSTICS ---"
            echo "Checking listening ports..."
            sudo netstat -tulpn | grep :80 || echo "Port 80 not found"
            
            echo "Checking Bitnami Nginx..."
            sudo cat /opt/bitnami/nginx/conf/server_blocks/*.conf || echo "Bitnami Nginx block not found"
            sudo cat /opt/bitnami/nginx/conf/bitnami/bitnami.conf || echo "Bitnami Nginx main conf not found"
            
            echo "Checking Standard Nginx..."
            sudo cat /etc/nginx/sites-enabled/* || echo "Standard Nginx sites not found"
            
            echo "Checking Apache..."
            sudo cat /etc/apache2/sites-enabled/* || echo "Apache sites not found"
            sudo cat /opt/bitnami/apache2/conf/vhosts/*.conf || echo "Bitnami Apache vhosts not found"
            
            echo "Checking localhost:80 response..."
            curl -I http://localhost:80 || echo "Localhost:80 failed"
            echo "------------------------------"
