name: Deploy to Lightsail

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          # Enable verbose SSH debugging
          debug: true
          # Increase timeout from default 30s to 60s
          timeout: "60s"
          script: |
            # DEBUG: Confirm script start
            echo "--- SCRIPT STARTING ---"

            # 1. Try to find Node/NPM manually if not in PATH
            # Common Bitnami path
            export PATH=$PATH:/opt/bitnami/node/bin
            # Common NVM path
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            # Check if we found them
            echo "Node Path: $(which node || echo 'NOT FOUND')"
            echo "NPM Path: $(which npm || echo 'NOT FOUND')"

            # Create Swap (Safe Mode: fail if password needed)
            if [ $(free -m | grep Mem: | awk '{print $2}') -lt 2000 ]; then
                echo "Detected low memory. Attempting to create swap..."
                if [ $(free -m | grep Swap: | awk '{print $2}') -eq 0 ]; then
                    # Try sudo without password (-n). If it fails, skips swap but continues script.
                    if sudo -n fallocate -l 1G /swapfile 2>/dev/null; then
                        echo "Swap file created."
                        sudo -n chmod 600 /swapfile
                        sudo -n mkswap /swapfile
                        sudo -n swapon /swapfile
                        echo "Swap enabled."
                    else
                        echo "WARNING: Could not create swap (sudo requires password). Proceeding without it."
                        echo "If build fails with OOM, please manually set up swap on server."
                    fi
                else
                    echo "Swap already exists."
                fi
            fi

            # Check again
            if ! command -v npm &> /dev/null; then
                echo "CRITICAL: npm not found. Sourcing .profile as last resort..."
                # Only source if absolutely necessary, and hope it's not interactive
                source ~/.profile || true
            fi

            # Debug info
            echo "Deploying as: $(whoami)"
            echo "In directory: $(pwd)"
            echo "Node Version: $(node -v)"
            echo "NPM Version: $(npm -v)"
            
            echo "--- ENV VARS (Keys Only) ---"
            printenv | cut -d= -f1 | sort
            echo "----------------------------"

            # Fix permissions
            sudo chown -R $USER:$USER tripplanner || true

            # Navigate
            cd tripplanner
            
            # Force sync with remote (discard local changes/conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            npm install
            
            # Verify file system state
            echo "--- FILE SYSTEM CHECK ---"
            echo "Current Commit on Server:"
            git log -1
            echo "Checking for API route:"
            ls -R src/app/api || echo "WARNING: src/app/api not found"
            echo "-------------------------"
            
            # Create a version file to verify build
            echo "Build Date: $(date)" > public/version.txt
            
            # Enable strict error handling
            set -e
            set -o pipefail

            # Resource Check
            echo "--- RESOURCE CHECK ---"
            echo "Disk Space:"
            df -h
            echo "Memory:"
            free -m
            echo "----------------------"

            # Clean build artifact to force fresh build
            rm -rf .next
            
            echo "Starting Build with Memory Limit..."
            # Limit Node memory to 512MB to prevent OOM on 1GB instance
            # Run build with pipefail to catch errors while logging
            if NODE_OPTIONS='--max-old-space-size=512' npm run build 2>&1 | tee build.log; then
                echo "Build SUCCESS"
            else
                echo "❌ BUILD FAILED"
                echo "--- BUILD LOG (Last 50 lines) ---"
                tail -n 50 build.log
                echo "---------------------------------"
                exit 1
            fi
            
            # Verify build output
            echo "--- BUILD VERIFICATION ---"
            if [ -d ".next" ]; then
                echo "✅ .next directory exists"
                ls -la .next
            else
                echo "❌ .next directory MISSING"
                exit 1
            fi
            grep "api/version" build.log || echo "WARNING: api/version NOT found in build output"
            echo "--------------------------"
            
            # Kill anything on port 3000
            # Kill anything on port 3000 (Try fuser if available, otherwise rely on PM2)
            echo "Killing process on port 3000..."
            sudo fuser -k 3000/tcp || true
            
            # Force restart from THIS directory
            pm2 delete lfg-places || true
            
            # Start strict process using bash wrapper to ensure environment is loaded
            # We use the npm found in path (which includes /opt/bitnami/node/bin)
            echo "Starting PM2..."
            pm2 start npm --name "lfg-places" -- start
            pm2 save
            
            # Process Diagnostics
            echo "--- PROCESS DIAGNOSTICS ---"
            pm2 describe lfg-places
            echo "---------------------------"
            pm2 save
            
            # Process Diagnostics
            echo "--- PROCESS DIAGNOSTICS ---"
            pm2 describe lfg-places
            echo "---------------------------"
            
            # Wait for service to be ready
            echo "Waiting for port 3000..."
            for i in {1..30}; do
              if timeout 1 bash -c 'cat < /dev/null > /dev/tcp/localhost/3000' 2> /dev/null; then
                echo "Port 3000 is open!"
                break
              fi
              echo "Waiting..."
              sleep 1
            done
            
            # Verify local operation
            echo "Verifying local server..."
            curl -v http://localhost:3000/api/version || echo "WARNING: Local verify failed"
            echo "---------------------"
            
            # Diagnostic: Check web server config
            echo "--- WEB SERVER DIAGNOSTICS ---"
            echo "Checking listening ports..."
            sudo netstat -tulpn | grep :80 || echo "Port 80 not found"
            
            echo "Checking Bitnami Nginx..."
            sudo cat /opt/bitnami/nginx/conf/server_blocks/*.conf || echo "Bitnami Nginx block not found"
            sudo cat /opt/bitnami/nginx/conf/bitnami/bitnami.conf || echo "Bitnami Nginx main conf not found"
            
            echo "Checking Standard Nginx..."
            sudo cat /etc/nginx/sites-enabled/* || echo "Standard Nginx sites not found"
            
            echo "Checking Apache..."
            sudo cat /etc/apache2/sites-enabled/* || echo "Apache sites not found"
            sudo cat /opt/bitnami/apache2/conf/vhosts/*.conf || echo "Bitnami Apache vhosts not found"
            
            echo "Checking localhost:80 response..."
            curl -I http://localhost:80 || echo "Localhost:80 failed"
            echo "------------------------------"
            
            # Restart Apache to clear stale proxy connections
            echo "Restarting Apache..."
            sudo /opt/bitnami/ctlscript.sh restart apache || sudo systemctl restart bitnami.apache || echo "WARNING: Apache restart failed"
            
            # Final check
            echo "Final check of public URL (via localhost:80)..."
            curl -v http://localhost:80/api/version || echo "WARNING: Public API check failed"
