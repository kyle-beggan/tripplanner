name: Deploy to Lightsail

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # Load environment (for npm/pm2)
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            else
              echo "WARNING: nvm.sh not found in default location"
            fi
            
            # Source profile files to load nvm/node from other locations
            source ~/.profile || true
            source ~/.bashrc || true
            
            # Check availability
            command -v nvm || echo "nvm not found"
            command -v node || echo "node not found"
            command -v npm || echo "npm not found"

            # Create Swap if low memory (critical for 1GB instances)
            if [ $(free -m | grep Mem: | awk '{print $2}') -lt 2000 ]; then
                echo "Detected low memory environment. Checking for swap..."
                if [ $(free -m | grep Swap: | awk '{print $2}') -eq 0 ]; then
                    echo "Creating 1GB Swap file..."
                    sudo fallocate -l 1G /swapfile
                    sudo chmod 600 /swapfile
                    sudo mkswap /swapfile
                    sudo swapon /swapfile
                    echo "Swap created."
                else
                    echo "Swap already exists."
                fi
            fi

            # Ensure proper Node version (v20)
            nvm install 20 || echo "nvm install failed, continuing with system node..."
            nvm use 20 || echo "nvm use failed, continuing..."

            # Debug info
            echo "Deploying as: $(whoami)"
            echo "In directory: $(pwd)"
            echo "Node Version: $(node -v)"
            echo "NPM Version: $(npm -v)"
            
            echo "--- ENV VARS (Keys Only) ---"
            printenv | cut -d= -f1 | sort
            echo "----------------------------"

            # Fix permissions
            sudo chown -R $USER:$USER tripplanner || true

            # Navigate
            cd tripplanner
            
            # Force sync with remote (discard local changes/conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            npm install
            
            # Verify file system state
            echo "--- FILE SYSTEM CHECK ---"
            echo "Current Commit on Server:"
            git log -1
            echo "Checking for API route:"
            ls -R src/app/api || echo "WARNING: src/app/api not found"
            echo "-------------------------"
            
            # Create a version file to verify build
            echo "Build Date: $(date)" > public/version.txt
            
            # Enable strict error handling
            set -e
            set -o pipefail

            # Resource Check
            echo "--- RESOURCE CHECK ---"
            echo "Disk Space:"
            df -h
            echo "Memory:"
            free -m
            echo "----------------------"

            # Clean build artifact to force fresh build
            rm -rf .next
            
            echo "Starting Build with Memory Limit..."
            # Limit Node memory to 512MB to prevent OOM on 1GB instance
            # Run build with pipefail to catch errors while logging
            if NODE_OPTIONS='--max-old-space-size=512' npm run build 2>&1 | tee build.log; then
                echo "Build SUCCESS"
            else
                echo "❌ BUILD FAILED"
                echo "--- BUILD LOG (Last 50 lines) ---"
                tail -n 50 build.log
                echo "---------------------------------"
                exit 1
            fi
            
            # Verify build output
            echo "--- BUILD VERIFICATION ---"
            if [ -d ".next" ]; then
                echo "✅ .next directory exists"
                ls -la .next
            else
                echo "❌ .next directory MISSING"
                exit 1
            fi
            grep "api/version" build.log || echo "WARNING: api/version NOT found in build output"
            echo "--------------------------"
            
            # Kill anything on port 3000
            echo "Killing process on port 3000..."
            sudo fuser -k 3000/tcp || true
            sudo kill -9 $(sudo lsof -t -i:3000) || true
            
            # Force restart from THIS directory with CORRECT Node version
            pm2 delete lfg-places || true
            
            # Identify correct Node path
            NODE_PATH=$(nvm which 20)
            echo "Using Node (Server Binary): $NODE_PATH"
            echo "Using Node (Current Shell): $(node -v)"
            echo "Using NPM (Current Shell): $(npm -v)"
            
            # Start strict process using bash wrapper to ensure environment is loaded
            # This is the "Nuclear Option" for NVM + PM2
            pm2 start bash --name "lfg-places" -- -c "source $HOME/.nvm/nvm.sh && nvm use 20 && npm start -- -p 3000"
            pm2 save
            
            # Process Diagnostics
            echo "--- PROCESS DIAGNOSTICS ---"
            pm2 describe lfg-places
            echo "---------------------------"
            
            # Wait for service to be ready
            echo "Waiting for port 3000..."
            for i in {1..30}; do
              if timeout 1 bash -c 'cat < /dev/null > /dev/tcp/localhost/3000' 2> /dev/null; then
                echo "Port 3000 is open!"
                break
              fi
              echo "Waiting..."
              sleep 1
            done
            
            # Verify local operation
            echo "Verifying local server..."
            curl -v http://localhost:3000/api/version || echo "WARNING: Local verify failed"
            echo "---------------------"
            
            # Diagnostic: Check web server config
            echo "--- WEB SERVER DIAGNOSTICS ---"
            echo "Checking listening ports..."
            sudo netstat -tulpn | grep :80 || echo "Port 80 not found"
            
            echo "Checking Bitnami Nginx..."
            sudo cat /opt/bitnami/nginx/conf/server_blocks/*.conf || echo "Bitnami Nginx block not found"
            sudo cat /opt/bitnami/nginx/conf/bitnami/bitnami.conf || echo "Bitnami Nginx main conf not found"
            
            echo "Checking Standard Nginx..."
            sudo cat /etc/nginx/sites-enabled/* || echo "Standard Nginx sites not found"
            
            echo "Checking Apache..."
            sudo cat /etc/apache2/sites-enabled/* || echo "Apache sites not found"
            sudo cat /opt/bitnami/apache2/conf/vhosts/*.conf || echo "Bitnami Apache vhosts not found"
            
            echo "Checking localhost:80 response..."
            curl -I http://localhost:80 || echo "Localhost:80 failed"
            echo "------------------------------"
            
            # Restart Apache to clear stale proxy connections
            echo "Restarting Apache..."
            sudo /opt/bitnami/ctlscript.sh restart apache || sudo systemctl restart bitnami.apache || echo "WARNING: Apache restart failed"
            
            # Final check
            echo "Final check of public URL (via localhost:80)..."
            curl -v http://localhost:80/api/version || echo "WARNING: Public API check failed"
