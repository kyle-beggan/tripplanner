name: Deploy to Lightsail

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # Load environment (for npm/pm2)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            source ~/.profile || true
            source ~/.bashrc || true

            # Debug info
            echo "Deploying as: $(whoami)"
            echo "In directory: $(pwd)"

            # Fix permissions
            sudo chown -R $USER:$USER tripplanner || true

            # Navigate
            cd tripplanner
            
            # Force sync with remote (discard local changes/conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            npm install
            
            # Create a version file to verify build
            echo "Build Date: $(date)" > public/version.txt
            
            # Clean build artifact to force fresh build
            rm -rf .next
            npm run build
            
            # Force restart from THIS directory
            pm2 delete lfg-places || true
            # Explicitly start on port 3000
            pm2 start npm --name "lfg-places" -- start -- -p 3000
            pm2 save
            
            # Verify local operation
            echo "Verifying local server..."
            sleep 5
            echo "--- LOCAL VERSION ---"
            curl http://localhost:3000/version.txt || echo "WARNING: Local verify failed"
            echo "---------------------"
            
            # Diagnostic: Check Nginx config (to see where it's pointing)
            echo "--- NGINX CONFIG ---"
            sudo cat /etc/nginx/sites-enabled/* || echo "WARNING: Could not read Nginx config"
            echo "--------------------"
