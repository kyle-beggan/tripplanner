name: Deploy to Lightsail

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # Load environment (for npm/pm2)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            source ~/.profile || true
            source ~/.bashrc || true
            
            # Ensure proper Node version (v20)
            nvm install 20
            nvm use 20

            # Debug info
            echo "Deploying as: $(whoami)"
            echo "In directory: $(pwd)"

            # Fix permissions
            sudo chown -R $USER:$USER tripplanner || true

            # Navigate
            cd tripplanner
            
            # Force sync with remote (discard local changes/conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            npm install
            
            # Verify file system state
            echo "--- FILE SYSTEM CHECK ---"
            echo "Current Commit on Server:"
            git log -1
            echo "Checking for API route:"
            ls -R src/app/api || echo "WARNING: src/app/api not found"
            echo "-------------------------"
            
            # Create a version file to verify build
            echo "Build Date: $(date)" > public/version.txt
            
            # Clean build artifact to force fresh build
            rm -rf .next
            npm run build 2>&1 | tee build.log
            
            # Verify build output
            echo "--- BUILD VERIFICATION ---"
            grep "api/version" build.log || echo "WARNING: api/version NOT found in build output"
            echo "--------------------------"
            
            # Force restart from THIS directory with CORRECT Node version
            pm2 delete lfg-places || true
            
            # Identify correct Node path
            NODE_PATH=$(nvm which 20)
            echo "Using Node: $NODE_PATH"
            
            # Start strict process
            # Note: We point directly to the NVM node executable as interpreter
            pm2 start npm --name "lfg-places" --interpreter "$NODE_PATH" -- start -- -p 3000
            pm2 save
            
            # Process Diagnostics
            echo "--- PROCESS DIAGNOSTICS ---"
            pm2 describe lfg-places
            echo "---------------------------"
            
            # Wait for service to be ready
            echo "Waiting for port 3000..."
            for i in {1..30}; do
              if timeout 1 bash -c 'cat < /dev/null > /dev/tcp/localhost/3000' 2> /dev/null; then
                echo "Port 3000 is open!"
                break
              fi
              echo "Waiting..."
              sleep 1
            done
            
            # Verify local operation
            echo "Verifying local server..."
            curl -v http://localhost:3000/api/version || echo "WARNING: Local verify failed"
            echo "---------------------"
            
            # Diagnostic: Check web server config
            echo "--- WEB SERVER DIAGNOSTICS ---"
            echo "Checking listening ports..."
            sudo netstat -tulpn | grep :80 || echo "Port 80 not found"
            
            echo "Checking Bitnami Nginx..."
            sudo cat /opt/bitnami/nginx/conf/server_blocks/*.conf || echo "Bitnami Nginx block not found"
            sudo cat /opt/bitnami/nginx/conf/bitnami/bitnami.conf || echo "Bitnami Nginx main conf not found"
            
            echo "Checking Standard Nginx..."
            sudo cat /etc/nginx/sites-enabled/* || echo "Standard Nginx sites not found"
            
            echo "Checking Apache..."
            sudo cat /etc/apache2/sites-enabled/* || echo "Apache sites not found"
            sudo cat /opt/bitnami/apache2/conf/vhosts/*.conf || echo "Bitnami Apache vhosts not found"
            
            echo "Checking localhost:80 response..."
            curl -I http://localhost:80 || echo "Localhost:80 failed"
            echo "------------------------------"
            
            # Restart Apache to clear stale proxy connections
            echo "Restarting Apache..."
            sudo /opt/bitnami/ctlscript.sh restart apache || sudo systemctl restart bitnami.apache || echo "WARNING: Apache restart failed"
            
            # Final check
            echo "Final check of public URL (via localhost:80)..."
            curl -v http://localhost:80/api/version || echo "WARNING: Public API check failed"
