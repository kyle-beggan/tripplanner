name: Deploy to Lightsail

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # Load environment (for npm/pm2)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            source ~/.profile || true
            source ~/.bashrc || true

            # Fix permissions (must be done before cd and git, assuming parent dir is accessible)
            # If tripplanner doesn't exist yet, git clone will create it with correct permissions
            # If it exists with bad permissions, this fixes it.
            sudo chown -R $USER:$USER tripplanner || true

            # Navigate to project directory
            cd tripplanner
            
            # Pull latest changes
            git pull origin main
            
            # Install dependencies
            npm install
            
            # Build application
            npm run build
            
            # Restart PM2 process (or start if not running)
            pm2 restart lfg-places || pm2 start npm --name "lfg-places" -- start
